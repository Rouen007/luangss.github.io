#虚拟文件系统

虚拟文件系统（VFS）是linux内核和具体I/O设备之间的封装的一层共通访问接口，通过这层接口，linux内核可以以同一的方式访问各种I/O设备。

虚拟文件系统本身是linux内核的一部分，是纯软件的东西，并不需要任何硬件的支持。

主要内容：

1. 虚拟文件系统的作用
2. 虚拟文件系统的4个主要对象
3. 文件系统相关的数据结构
4. 进程相关的数据结构
5. 小结

##虚拟文件系统的作用

虚拟文件系统(VFS)是linux内核和存储设备之间的抽象层，主要有以下好处。

- 简化了应用程序的开发：应用通过统一的系统调用访问各种存储介质

- 简化了新文件系统加入内核的过程：新文件系统只要实现VFS的各个接口即可，不需要修改内核部分

##虚拟文件系统的4个主要对象

1. 超级块对象：一个具体已安装文件系统。
2. 索引节点对象：一个具体文件。
3. 目录项对象：一个目录项，是路径的一个组成部分。
4. 文件对象：由进程打开的文件。

###超级块

超级块(super_block)主要存储文件系统相关的信息，这是个针对文件系统级别的概念。

各种文件系统都必须实现超级块对象。

它一般存储在磁盘的特定扇区中，但是对于那些基于内存的文件系统(比如proc,sysfs)，超级块是在使用时创建在内存中的。

###索引节点

索引节点是VFS中的核心概念，它包含内核在操作文件或目录时需要的全部信息。

一个索引节点代表文件系统中的一个文件(这里的文件不仅是指我们平时所认为的普通的文件，还包括目录，特殊设备文件等等)。

索引节点和超级块一样是实际存储在磁盘上的，当被应用程序访问到时才会在内存中创建。

###目录项

和超级块和索引节点不同，目录项并不是实际存在于磁盘上的。

在使用的时候在内存中创建目录项对象，其实通过索引节点已经可以定位到指定的文件，

但是索引节点对象的属性非常多，在查找，比较文件时，直接用索引节点效率不高，所以引入了目录项的概念。

路径中的每个部分都是一个目录项，比如路径： /mnt/cdrom/foo/bar 其中包含5个目录项，/ mnt cdrom foo bar

每个目录项对象都有3种状态：被使用，未使用和负状态

- 被使用：对应一个有效的索引节点，并且该对象由一个或多个使用者
- 未使用：对应一个有效的索引节点，但是VFS当前并没有使用这个目录项
- 负状态：没有对应的有效索引节点（可能索引节点被删除或者路径不存在了）

目录项的目的就是提高文件查找，比较的效率，所以访问过的目录项都会缓存在slab中。 

目录项缓存包括三个主要部分：
1. “被使用的”目录项链表
2. “最近被使用的”双向链表
3. 散列表和相应的散列函数用来快速地将给定路径解析为相关目录项对象。

###文件对象

文件对象表示进程已打开的文件，从用户角度来看，我们在代码中操作的就是一个文件对象。

文件对象反过来指向一个目录项对象（目录项反过来指向一个索引节点）

其实只有目录项对象才表示一个已打开的实际文件，虽然一个文件对应的文件对象不是唯一的，但其对应的索引节点和目录项对象却是唯一的。

###四个对象之间关系图

上面分别介绍了4种对象分别的属性和方法,下面用图来展示这4个对象的和VFS之间关系以及4个对象之间的关系。

![image](https://github.com/Rouen007/luangss.github.io/blob/master/image-lib/13.2.PNG)

![image](https://github.com/Rouen007/luangss.github.io/blob/master/image-lib/13.1.PNG)

##文件系统相关的数据结构

处理上面4个主要的对象之外，VFS中还有2个专门针对文件系统的2个对象，

- struct file_system_type: 用来描述文件系统的类型（比如ext3,ntfs等等）

- struct vfsmount        : 描述一个安装文件系统的实例

每种文件系统,不管由多少个实例安装到系统中,还是根本没有安装到系统中,都只有一个 file_system_type 结构。

当文件系统被实际安装时，会在安装点创建一个 vfsmount 结构体。

结构体代表文件系统的实例，也就是文件系统被安装几次，就会创建几个 vfsmount

vfsmount 的定义参见：<linux/mount.h>

##进程相关的数据结构

以上介绍的都是在内核角度看到的 VFS 各个结构，所以结构体中包含的属性非常多。

而从进程的角度来看的话，大多数时候并不需要那么多的属性，所有VFS通过以下3个结构体和进程紧密联系在一起。

- struct files_struct  ：由进程描述符中的 files 目录项指向，所有与单个进程相关的信息(比如打开的文件和文件描述符)都包含在其中。

- struct fs_struct     ：由进程描述符中的 fs 域指向，包含文件系统和进程相关的信息。

- struct mmt_namespace ：由进程描述符中的 mmt_namespace 域指向。

##小结

VFS 统一了文件系统的实现框架，使得在linux上实现新文件系统的工作变得简单。

目前linux内核中已经支持60多种文件系统，具体支持的文件系统可以查看 内核源码 fs 文件夹下的内容。

















